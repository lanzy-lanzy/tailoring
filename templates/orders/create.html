{% extends 'base.html' %}
{% load tz %}

{% block title %}Create Order - El Senior Original Tailoring{% endblock %}
{% block page_title %}Create New Order{% endblock %}

{% block extra_css %}
<style>
    /* Screen styles for receipt preview */
    @media screen {
        .receipt-page {
            max-width: 210mm;
            margin: 0 auto;
            background: white;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
    }
    
    /* Print styles for A4 - Single Page */
    @media print {
        * {
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
            color-adjust: exact !important;
        }
        
        html, body {
            width: 210mm;
            height: 297mm;
            margin: 0 !important;
            padding: 0 !important;
            font-size: 11px !important;
            background: white !important;
        }
        
        /* Hide everything except receipt */
        body * { 
            visibility: hidden !important; 
        }
        
        #deposit-receipt, 
        #deposit-receipt * { 
            visibility: visible !important; 
        }
        
        .no-print,
        aside,
        header,
        nav,
        .lg\\:translate-x-0,
        .lg\\:static {
            display: none !important;
        }
        
        #deposit-receipt { 
            position: absolute !important; 
            left: 0 !important; 
            top: 0 !important; 
            width: 210mm !important;
            height: 297mm !important;
            max-width: 100% !important;
            margin: 0 !important;
            padding: 8mm 12mm !important;
            box-shadow: none !important;
            border: none !important;
            border-radius: 0 !important;
            box-sizing: border-box !important;
            overflow: hidden !important;
            background: white !important;
        }
        
        /* Background colors */
        .bg-green-600 { background-color: #6D4A2A !important; }
        .bg-green-600 { background-color: #8B5E34 !important; }
        .bg-green-500 { background-color: #F0E6D8 !important; }
        .bg-cream-5000 { background-color: #FFF9E6 !important; }
        .bg-cream-500 { background-color: #FFFDF7 !important; }
         .bg-green-500 { background-color: #22c55e !important; }
         .bg-green-50 { background-color: #f0fdf4 !important; }
         .bg-green-100 { background-color: #dcfce7 !important; }
         .bg-blue-100 { background-color: #dbeafe !important; }
         .bg-purple-100 { background-color: #f3e8ff !important; }

         /* Text colors */
         .text-white { color: white !important; }
         .text-cream-500 { color: #FFF3CC !important; }
         .text-cream-500 { color: #FFF9E6 !important; }
         .text-green-600 { color: #16a34a !important; }
         .text-green-500 { color: #22c55e !important; }
         .text-green-800 { color: #166534 !important; }
         .text-blue-700 { color: #1d4ed8 !important; }
         .text-purple-700 { color: #7c3aed !important; }
         .text-salmon-500 { color: #dc2626 !important; }
        
        /* Border colors */
        .border-green-500 { border-color: #22c55e !important; }
        .border-green-200 { border-color: #E0CCB0 !important; }
        .border-green-300 { border-color: #C9A97C !important; }
        .border-green-400 { border-color: #A67C52 !important; }
    }
    
    @page {
        size: A4 portrait;
        margin: 0;
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto" x-data="orderForm()" x-init="init()" x-cloak>
    <!-- Breadcrumb -->
    <nav class="mb-6">
        <ol class="flex items-center space-x-2 text-sm text-green-600">
            <li>
                <a href="{% url 'order_list' %}" class="hover:text-green-700 transition-colors">Orders</a>
            </li>
            <li>
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                </svg>
            </li>
            <li class="text-green-800 font-medium">Create New Order</li>
        </ol>
    </nav>

    <form @submit.prevent="showConfirmation()" class="space-y-6">
        {% csrf_token %}

        <!-- Customer Selection -->
        <div class="bg-white rounded-xl shadow-sm border border-green-100 overflow-hidden">
            <div class="px-6 py-4 border-b border-green-100 bg-gradient-to-r from-brown-50 to-cream-50">
                <div class="flex items-center">
                    <div class="w-10 h-10 bg-green-500 rounded-lg flex items-center justify-center mr-3">
                        <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                        </svg>
                    </div>
                    <div>
                        <h2 class="text-lg font-semibold text-green-800">Customer Information</h2>
                        <p class="text-sm text-green-600">Select an existing customer or create a new one</p>
                    </div>
                </div>
            </div>
            <div class="p-6">
                <div class="space-y-4">
                    <!-- Customer Selection Toggle -->
                    <div class="flex items-center space-x-6 mb-4">
                        <label class="inline-flex items-center cursor-pointer group">
                            <input type="radio" name="customer_mode" value="existing" x-model="customerMode" 
                                   class="w-4 h-4 text-green-600 focus:ring-green-400 border-green-300">
                            <span class="ml-2 text-green-700 group-hover:text-green-900 transition-colors">Select Existing Customer</span>
                        </label>
                        <label class="inline-flex items-center cursor-pointer group">
                            <input type="radio" name="customer_mode" value="new" x-model="customerMode"
                                   class="w-4 h-4 text-green-600 focus:ring-green-400 border-green-300">
                            <span class="ml-2 text-green-700 group-hover:text-green-900 transition-colors">Create New Customer</span>
                        </label>
                    </div>

                    <!-- Existing Customer Select -->
                    <div x-show="customerMode === 'existing'" x-transition>
                        <label for="id_customer" class="block text-sm font-medium text-green-700 mb-2">
                            Select Customer <span class="text-salmon-500">*</span>
                        </label>
                        <select name="customer" id="id_customer" x-model="selectedCustomer"
                                @change="updateCustomerInfo()"
                                class="w-full px-4 py-3 border border-green-200 rounded-lg focus:ring-2 focus:ring-green-400 focus:border-transparent bg-white text-green-800">
                            <option value="">-- Select a customer --</option>
                            {% for customer in customers %}
                            <option value="{{ customer.pk }}" 
                                    data-name="{{ customer.name }}" 
                                    data-phone="{{ customer.contact_number }}"
                                    data-email="{{ customer.email|default:'' }}">
                                {{ customer.name }} - {{ customer.contact_number }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- New Customer Form -->
                    <div x-show="customerMode === 'new'" x-transition class="space-y-4 p-5 bg-gradient-to-br from-cream-50 to-brown-50 rounded-xl border border-cream-500">
                        <input type="hidden" name="create_new_customer" x-bind:value="customerMode === 'new' ? 'true' : 'false'">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-green-700 mb-2">
                                    Customer Name <span class="text-salmon-500">*</span>
                                </label>
                                <input type="text" name="new_customer_name" x-model="newCustomerName"
                                       class="w-full px-4 py-3 border border-green-200 rounded-lg focus:ring-2 focus:ring-green-400 bg-white"
                                       placeholder="Enter customer name">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-green-700 mb-2">
                                    Contact Number <span class="text-salmon-500">*</span>
                                </label>
                                <input type="tel" name="new_customer_phone" x-model="newCustomerPhone"
                                       class="w-full px-4 py-3 border border-green-200 rounded-lg focus:ring-2 focus:ring-green-400 bg-white"
                                       placeholder="09171234567">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Garment & Fabric Selection -->
        <div class="bg-white rounded-xl shadow-sm border border-green-100 overflow-hidden">
            <div class="px-6 py-4 border-b border-green-100 bg-gradient-to-r from-brown-50 to-cream-50">
                <div class="flex items-center">
                    <div class="w-10 h-10 bg-green-500 rounded-lg flex items-center justify-center mr-3">
                        <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"/>
                        </svg>
                    </div>
                    <div>
                        <h2 class="text-lg font-semibold text-green-800">Garment & Fabric</h2>
                        <p class="text-sm text-green-600">Select the garment type and fabric</p>
                    </div>
                </div>
            </div>
            <div class="p-6 space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                     <!-- Garment Type -->
                     <div>
                          <label class="block text-sm font-medium text-green-700 mb-2">
                              Garment Type <span class="text-salmon-500">*</span>
                          </label>
                          <select name="garment_type" id="id_garment_type" x-model="selectedGarment" @change="updateGarmentInfo()"
                                  class="w-full px-4 py-3 border border-green-200 rounded-lg focus:ring-2 focus:ring-green-400 bg-white" required>
                              <option value="">-- Select garment --</option>
                              {% for garment in garment_types %}
                              <option value="{{ garment.pk }}"
                                      data-name="{{ garment.name }}"
                                      data-price="{{ garment.base_price }}"
                                      data-fabric="{{ garment.estimated_fabric_meters }}"
                                      data-category="{{ garment.garment_category }}"
                                      data-category-label="{% if garment.garment_category == 'upper' %}Upper Body{% elif garment.garment_category == 'lower' %}Lower Body{% elif garment.garment_category == 'both' %}Upper & Lower{% endif %}">
                                  {% if garment.garment_category == 'upper' %}[U] {% endif %}
                                  {% if garment.garment_category == 'lower' %}[L] {% endif %}
                                  {% if garment.garment_category == 'both' %}[B] {% endif %}
                                  {{ garment.name }}
                              </option>
                              {% endfor %}
                          </select>
                          <div x-show="selectedGarment" class="mt-2 flex items-center space-x-2">
                              <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium"
                                    :class="{
                                        'bg-blue-100 text-blue-800': garmentCategory === 'upper',
                                        'bg-green-100 text-green-800': garmentCategory === 'lower',
                                        'bg-purple-100 text-purple-800': garmentCategory === 'both'
                                    }">
                                  <template x-if="garmentCategory === 'upper'">Upper Body</template>
                                  <template x-if="garmentCategory === 'lower'">Lower Body</template>
                                  <template x-if="garmentCategory === 'both'">Upper & Lower</template>
                              </span>
                              <span class="text-xs text-green-600">Selected</span>
                          </div>
                      </div>

                    <!-- Fabric Color Filter -->
                    <div>
                        <label class="block text-sm font-medium text-green-700 mb-2">
                            Fabric Color <span class="text-salmon-500">*</span>
                        </label>
                        <select id="id_fabric_color" x-model="selectedFabricColor" @change="filterFabricsByColor()"
                                class="w-full px-4 py-3 border border-green-200 rounded-lg focus:ring-2 focus:ring-green-400 bg-white" required>
                            <option value="">-- Filter by color --</option>
                        </select>
                    </div>

                    <!-- Fabric -->
                    <div>
                        <label class="block text-sm font-medium text-green-700 mb-2">
                            Select Fabric <span class="text-salmon-500">*</span>
                        </label>
                        <select name="fabric" id="id_fabric" x-model="selectedFabric" @change="updateFabricInfo()"
                                class="w-full px-4 py-3 border border-green-200 rounded-lg focus:ring-2 focus:ring-green-400 bg-white" required>
                            <option value="">-- Select fabric --</option>
                        </select>
                        <div x-show="selectedFabric && fabricName" class="mt-2 text-xs text-green-600">
                            <span x-text="fabricName"></span> 
                            <span class="text-green-600" x-text="'(' + fabricAvailable + 'm available)'"></span>
                        </div>
                    </div>

                    <!-- Quantity -->
                    <div>
                        <label class="block text-sm font-medium text-green-700 mb-2">
                            Quantity <span class="text-salmon-500">*</span>
                        </label>
                        <input type="number" name="quantity" x-model.number="quantity" @input="calculateAll()"
                               min="1" value="1" required
                               class="w-full px-4 py-3 border border-green-200 rounded-lg focus:ring-2 focus:ring-green-400 bg-white">
                    </div>

                    <!-- Fabric Meters Input (Dynamic) -->
                    <div>
                        <label class="block text-sm font-medium text-green-700 mb-2">
                            Fabric Meters to Use <span class="text-salmon-500">*</span>
                        </label>
                        <div class="relative">
                            <input type="number" name="fabric_meters_used" x-model.number="fabricMetersUsed" @input="checkStock()"
                                   step="0.01" min="0" required
                                   class="w-full px-4 py-3 pr-12 border border-green-200 rounded-lg focus:ring-2 focus:ring-green-400 bg-white">
                            <span class="absolute right-4 top-3.5 text-green-600 text-sm font-medium">m</span>
                        </div>
                        <p x-show="selectedGarment" class="mt-1 text-xs text-green-600">
                            Suggested: <span x-text="estimatedFabricPerUnit"></span>m per garment × <span x-text="quantity"></span> = <span x-text="(estimatedFabricPerUnit * quantity).toFixed(2)"></span>m
                        </p>
                    </div>
                </div>

                <!-- Fabric Requirement Info -->
                <div x-show="selectedFabric && fabricMetersUsed > 0" x-transition 
                     class="p-4 rounded-lg" :class="hasSufficientStock ? 'bg-green-50 border border-green-200' : 'bg-salmon-50 border border-salmon-200'">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <template x-if="hasSufficientStock">
                                <svg class="w-5 h-5 text-green-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                </svg>
                            </template>
                            <template x-if="!hasSufficientStock">
                                <svg class="w-5 h-5 text-salmon-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                                </svg>
                            </template>
                            <span :class="hasSufficientStock ? 'text-green-800' : 'text-salmon-500'" class="font-medium">
                                Required: <span x-text="fabricMetersUsed.toFixed(2)"></span>m
                            </span>
                        </div>
                        <span :class="hasSufficientStock ? 'text-green-600' : 'text-salmon-500'" class="text-sm">
                            Available: <span x-text="fabricAvailable.toFixed(2)"></span>m
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Accessories Selection -->
        <div class="bg-white rounded-xl shadow-sm border border-green-100 overflow-hidden">
            <div class="px-6 py-4 border-b border-green-100 bg-gradient-to-r from-brown-50 to-cream-50">
                <div class="flex items-center">
                    <div class="w-10 h-10 bg-green-500 rounded-lg flex items-center justify-center mr-3">
                        <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
                        </svg>
                    </div>
                    <div>
                        <h2 class="text-lg font-semibold text-green-800">Accessories</h2>
                        <p class="text-sm text-green-600">Select accessories for this garment</p>
                    </div>
                </div>
            </div>
             <div class="p-6">
                 <!-- Search Input -->
                 <div class="mb-4">
                     <div class="relative">
                         <input type="text" x-model="accessorySearch" placeholder="Search accessories..." 
                                class="w-full px-4 py-3 pl-12 border border-green-200 rounded-lg focus:ring-2 focus:ring-green-400 focus:border-green-500">
                         <svg class="absolute left-4 top-3.5 w-5 h-5 text-cream-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                             <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                         </svg>
                     </div>
                     <p x-show="filteredAccessories.length === 0 && accessorySearch" class="mt-2 text-sm text-green-600 text-center">
                         No accessories found matching "<span x-text="accessorySearch"></span>"
                     </p>
                 </div>

                 <div class="grid grid-cols-1 md:grid-cols-2 gap-4" x-show="filteredAccessories.length > 0">
                     <template x-for="accessory in filteredAccessories" :key="accessory.id">
                         <div class="p-4 border border-green-200 rounded-lg hover:border-green-400 transition-colors">
                              <label class="flex items-start cursor-pointer">
                                  <input type="checkbox" 
                                         :value="String(accessory.id)"
                                         :name="'accessory_' + accessory.id"
                                         x-model="selectedAccessories"
                                         @change="updateAccessoryQuantity(accessory.id)"
                                         class="mt-1 w-4 h-4 text-green-600 focus:ring-green-400 border-green-300 rounded">
                                  <div class="ml-3 flex-1">
                                     <div class="flex items-center justify-between">
                                         <span class="font-medium text-green-800" x-text="accessory.name"></span>
                                         <span class="text-xs text-green-600" x-text="'(' + accessory.unit + ')'"></span>
                                     </div>
                                     <div class="mt-1 flex items-center justify-between">
                                         <span class="text-sm text-green-600">Available: <span x-text="accessory.stock"></span> <span class="text-xs text-green-600" x-text="accessory.unit"></span></span>
                                     </div>
                                     <div x-show="selectedAccessories.includes(String(accessory.id))" x-transition class="mt-2">
                                         <label class="block text-xs font-medium text-green-700 mb-1">Quantity to use (<span x-text="accessory.unit"></span>):</label>
                                         <div class="flex items-center gap-2">
                                             <button type="button"
                                                     @click="accessoryQuantities[accessory.id] = Math.max(0, (parseFloat(accessoryQuantities[accessory.id] || 0) - 0.5).toFixed(2)); checkAccessoryStock(accessory.id)"
                                                     class="w-8 h-8 flex items-center justify-center bg-green-500 hover:bg-green-500 text-green-700 rounded border border-green-300 transition-colors text-lg font-bold"
                                                     :class="{'opacity-50 cursor-not-allowed': parseFloat(accessoryQuantities[accessory.id] || 0) <= 0}">
                                                 −
                                             </button>
                                             <input type="number"
                                                    :name="'accessory_qty_' + accessory.id"
                                                    x-model.number="accessoryQuantities[accessory.id]"
                                                    @input="checkAccessoryStock(accessory.id)"
                                                    step="0.01" min="0"
                                                    class="flex-1 px-3 py-2 text-sm border border-green-300 rounded-lg focus:ring-2 focus:ring-green-400 focus:border-green-500 text-center font-medium">
                                             <button type="button"
                                                     @click="accessoryQuantities[accessory.id] = (parseFloat(accessoryQuantities[accessory.id] || 0) + 0.5).toFixed(2); checkAccessoryStock(accessory.id)"
                                                     class="w-8 h-8 flex items-center justify-center bg-green-500 hover:bg-green-500 text-green-700 rounded border border-green-300 transition-colors text-lg font-bold">
                                                 +
                                             </button>
                                             <span class="text-xs text-green-600" x-text="accessory.unit"></span>
                                         </div>
                                     </div>
                                 </div>
                             </label>
                         </div>
                     </template>
                 </div>

                <div x-show="selectedAccessories.length > 0" class="mt-4 p-4 bg-pink-50 rounded-lg border border-amber-200">
                    <h4 class="font-medium text-pink-500 mb-2">Selected Accessories:</h4>
                    <ul class="space-y-1 text-sm">
                        <template x-for="accessoryId in selectedAccessories" :key="accessoryId">
                            <li class="flex items-center justify-between">
                                <span class="text-pink-500">
                                    <span x-text="getAccessoryName(accessoryId)"></span>
                                    <span x-show="accessoryQuantities[accessoryId]" class="text-pink-500">
                                        × <span x-text="accessoryQuantities[accessoryId]"></span>
                                    </span>
                                </span>
                                <template x-if="accessoryQuantities[accessoryId] > getAccessoryStock(accessoryId)">
                                    <span class="text-salmon-500 font-medium text-xs">Insufficient stock!</span>
                                </template>
                            </li>
                        </template>
                    </ul>
                </div>
            </div>
        </div>

         <!-- Measurements -->
         <div class="bg-white rounded-xl shadow-sm border border-green-100 overflow-hidden">
             <div class="px-6 py-4 border-b border-green-100 bg-gradient-to-r from-brown-50 to-cream-50">
                 <div class="flex items-center justify-between">
                     <div class="flex items-center">
                         <div class="w-10 h-10 bg-green-500 rounded-lg flex items-center justify-center mr-3">
                             <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                 <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>
                             </svg>
                         </div>
                         <div>
                             <h2 class="text-lg font-semibold text-green-800">Measurements</h2>
                             <p class="text-sm text-green-600">Enter customer measurements (in inches)</p>
                         </div>
                     </div>
                     <div class="flex items-center space-x-3">
                         <div class="flex items-center space-x-1 text-xs">
                             <span class="flex items-center">
                                 <span class="w-3 h-3 bg-blue-600 rounded-full mr-1"></span>
                                 <span class="text-green-600">Upper</span>
                             </span>
                             <span class="flex items-center">
                                 <span class="w-3 h-3 bg-green-600 rounded-full mr-1"></span>
                                 <span class="text-green-600">Lower</span>
                             </span>
                             <span class="flex items-center">
                                 <span class="w-3 h-3 bg-purple-600 rounded-full mr-1"></span>
                                 <span class="text-green-600">Both</span>
                             </span>
                         </div>
                     </div>
                 </div>
             </div>
              <div class="p-6">
                  <div x-show="!garmentCategory" class="text-center py-12 text-green-600 bg-gradient-to-br from-brown-50 to-cream-50 rounded-xl border-2 border-dashed border-green-200">
                      <svg class="w-16 h-16 mx-auto mb-4 text-green-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>
                      </svg>
                      <p class="text-lg font-semibold text-green-700">Select a garment type first</p>
                      <p class="text-sm mt-1">Measurements will appear based on the selected garment category</p>
                  </div>

                  <div x-show="garmentCategory" x-transition>
                      <div x-show="showUpperMeasurements" x-transition class="mb-8 bg-blue-50 rounded-xl border-2 border-blue-200 overflow-hidden">
                          <div class="bg-blue-600 px-6 py-3 flex items-center justify-between">
                              <div class="flex items-center">
                                  <svg class="w-6 h-6 text-white mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>
                                  </svg>
                                  <h3 class="font-bold text-white text-lg">Upper Body Measurements</h3>
                              </div>
                              <span class="bg-white text-blue-700 px-3 py-1 rounded-full text-sm font-bold uppercase">Required</span>
                          </div>
                          <div class="p-6">
                              <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4">
                                  <template x-for="field in upperMeasurements" :key="field">
                                      <div>
                                          <label :for="'measure_' + field" class="block text-sm font-bold text-blue-800 mb-2 capitalize" x-text="field.replace('_', ' ')"></label>
                                          <div class="relative">
                                              <input type="number" :name="field" :id="'measure_' + field" x-model="measurements[field]"
                                                     step="0.25" min="0" placeholder="0"
                                                     class="w-full px-4 py-3 pr-12 border-2 border-blue-300 rounded-lg focus:ring-4 focus:ring-blue-400 focus:border-blue-500 bg-white text-lg transition-colors">
                                              <span class="absolute right-3 top-3.5 text-blue-500 text-sm font-bold">in</span>
                                          </div>
                                      </div>
                                  </template>
                              </div>
                          </div>
                      </div>

                      <div x-show="showLowerMeasurements" x-transition class="mb-8 bg-green-50 rounded-xl border-2 border-green-200 overflow-hidden">
                          <div class="bg-green-600 px-6 py-3 flex items-center justify-between">
                              <div class="flex items-center">
                                  <svg class="w-6 h-6 text-white mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>
                                  </svg>
                                  <h3 class="font-bold text-white text-lg">Lower Body Measurements</h3>
                              </div>
                              <span class="bg-white text-green-700 px-3 py-1 rounded-full text-sm font-bold uppercase">Required</span>
                          </div>
                          <div class="p-6">
                              <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4">
                                  <template x-for="field in lowerMeasurements" :key="field">
                                      <div>
                                          <label :for="'measure_' + field" class="block text-sm font-bold text-green-800 mb-2 capitalize" x-text="field.replace('_', ' ')"></label>
                                          <div class="relative">
                                              <input type="number" :name="field" :id="'measure_' + field" x-model="measurements[field]"
                                                     step="0.25" min="0" placeholder="0"
                                                     class="w-full px-4 py-3 pr-12 border-2 border-green-300 rounded-lg focus:ring-4 focus:ring-green-400 focus:border-green-500 bg-white text-lg transition-colors">
                                              <span class="absolute right-3 top-3.5 text-green-500 text-sm font-bold">in</span>
                                          </div>
                                      </div>
                                  </template>
                              </div>
                          </div>
                      </div>

                      <div x-show="garmentCategory" x-transition class="bg-purple-50 rounded-xl border-2 border-purple-200 overflow-hidden">
                          <div class="bg-purple-600 px-6 py-3 flex items-center justify-between">
                              <div class="flex items-center">
                                  <svg class="w-6 h-6 text-white mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                  </svg>
                                  <h3 class="font-bold text-white text-lg">Common Measurements</h3>
                              </div>
                              <span class="bg-white text-purple-700 px-3 py-1 rounded-full text-sm font-bold uppercase">Required</span>
                          </div>
                          <div class="p-6">
                              <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4">
                                  <template x-for="field in bothMeasurements" :key="field">
                                      <div>
                                          <label :for="'measure_' + field" class="block text-sm font-bold text-purple-800 mb-2 capitalize" x-text="field.replace('_', ' ')"></label>
                                          <div class="relative">
                                              <input type="number" :name="field" :id="'measure_' + field" x-model="measurements[field]"
                                                     step="0.25" min="0" placeholder="0"
                                                     class="w-full px-4 py-3 pr-12 border-2 border-purple-300 rounded-lg focus:ring-4 focus:ring-purple-400 focus:border-purple-500 bg-white text-lg transition-colors">
                                              <span class="absolute right-3 top-3.5 text-purple-500 text-sm font-bold">in</span>
                                          </div>
                                      </div>
                                  </template>
                              </div>
                          </div>
                      </div>

                      <div x-show="garmentCategory" class="mt-4 p-4 bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg border border-blue-200">
                          <div class="flex items-start">
                              <svg class="w-5 h-5 text-blue-600 mr-3 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
                              </svg>
                              <div class="text-sm text-green-700">
                                  <div class="flex items-center mb-2">
                                      <p class="font-bold">Garment: <span class="text-green-800" x-text="garmentName"></span></p>
                                      <span class="ml-3 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-bold uppercase"
                                            :class="{
                                                'bg-blue-600 text-white': garmentCategory === 'upper',
                                                'bg-green-600 text-white': garmentCategory === 'lower',
                                                'bg-purple-600 text-white': garmentCategory === 'both'
                                            }">
                                          <template x-if="garmentCategory === 'upper'">Upper Body</template>
                                          <template x-if="garmentCategory === 'lower'">Lower Body</template>
                                          <template x-if="garmentCategory === 'both'">Upper & Lower</template>
                                      </span>
                                  </div>
                                  <div class="space-y-1">
                                      <template x-if="garmentCategory === 'upper'">
                                          <p class="flex items-center">
                                              <span class="w-2 h-2 bg-blue-600 rounded-full mr-2"></span>
                                              Fill in upper body measurements (chest, shoulder, sleeve length, arm hole, cuff, neck, body length)
                                          </p>
                                      </template>
                                      <template x-if="garmentCategory === 'lower'">
                                          <p class="flex items-center">
                                              <span class="w-2 h-2 bg-green-600 rounded-full mr-2"></span>
                                              Fill in lower body measurements (inseam, outseam, thigh, knee, hem, rise)
                                          </p>
                                      </template>
                                      <template x-if="garmentCategory === 'both'">
                                          <p class="flex items-center">
                                              <span class="w-2 h-2 bg-purple-600 rounded-full mr-2"></span>
                                              Fill in BOTH upper and lower body measurements (all fields)
                                          </p>
                                      </template>
                                  </div>
                              </div>
                          </div>
                      </div>
                 </div>
             </div>
         </div>

        <!-- Pricing & Schedule -->
        <div class="bg-white rounded-xl shadow-sm border border-green-100 overflow-hidden">
            <div class="px-6 py-4 border-b border-green-100 bg-gradient-to-r from-brown-50 to-cream-50">
                <div class="flex items-center">
                    <div class="w-10 h-10 bg-green-500 rounded-lg flex items-center justify-center mr-3">
                        <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                    </div>
                    <div>
                        <h2 class="text-lg font-semibold text-green-800">Pricing & Schedule</h2>
                        <p class="text-sm text-green-600">Set the price, payment option, and due date</p>
                    </div>
                </div>
            </div>
            <div class="p-6">
                <!-- Payment Option Selection -->
                <div class="mb-6 p-4 bg-gradient-to-r from-cream-50 to-brown-50 rounded-xl border border-cream-500">
                    <label class="block text-sm font-medium text-green-700 mb-3">
                        Payment Option <span class="text-salmon-500">*</span>
                    </label>
                    <div class="flex items-center space-x-6">
                        <label class="inline-flex items-center cursor-pointer group">
                            <input type="radio" name="payment_option" value="deposit" x-model="paymentOption" @change="calculateDeposit()"
                                   class="w-5 h-5 text-green-600 focus:ring-green-400 border-green-300">
                            <span class="ml-3 text-green-700 group-hover:text-green-900 transition-colors">
                                <span class="font-medium">50% Deposit</span>
                                <span class="text-sm text-green-600 block">Pay half now, balance on pickup</span>
                            </span>
                        </label>
                        <label class="inline-flex items-center cursor-pointer group">
                            <input type="radio" name="payment_option" value="full" x-model="paymentOption" @change="calculateDeposit()"
                                   class="w-5 h-5 text-green-600 focus:ring-green-400 border-green-300">
                            <span class="ml-3 text-green-700 group-hover:text-green-900 transition-colors">
                                <span class="font-medium text-green-700">Full Payment</span>
                                <span class="text-sm text-green-600 block">Pay full amount now</span>
                            </span>
                        </label>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                    <!-- Total Price -->
                    <div>
                        <label class="block text-sm font-medium text-green-700 mb-2">
                            Total Price <span class="text-salmon-500">*</span>
                        </label>
                        <div class="relative">
                            <span class="absolute left-4 top-3 text-green-600 font-medium">₱</span>
                            <input type="number" name="total_price" x-model.number="totalPrice" @input="calculateDeposit()"
                                   step="0.01" min="0" required
                                   class="w-full pl-10 pr-4 py-3 border border-green-200 rounded-lg focus:ring-2 focus:ring-green-400 bg-white text-lg font-semibold">
                        </div>
                    </div>

                    <!-- Payment Amount -->
                    <div>
                        <label class="block text-sm font-medium text-green-700 mb-2">
                            <span x-text="paymentOption === 'full' ? 'Full Payment' : 'Deposit (50%)'"></span> <span class="text-salmon-500">*</span>
                        </label>
                        <div class="relative">
                            <span class="absolute left-4 top-3 text-green-600 font-medium">₱</span>
                            <input type="number" name="deposit_amount" x-model.number="depositAmount" readonly
                                   :class="paymentOption === 'full' ? 'bg-green-50 border-green-300 text-green-700' : 'bg-cream-500 text-green-700'"
                                   class="w-full pl-10 pr-4 py-3 border border-green-200 rounded-lg text-lg font-semibold">
                        </div>
                    </div>

                    <!-- Balance -->
                    <div>
                        <label class="block text-sm font-medium text-green-700 mb-2">Balance Due</label>
                        <div :class="paymentOption === 'full' ? 'bg-green-50 border-green-200' : 'bg-gradient-to-r from-cream-100 to-brown-50 border-green-200'" 
                             class="px-4 py-3 border rounded-lg">
                            <span :class="paymentOption === 'full' ? 'text-green-600' : 'text-green-800'" class="text-lg font-bold">
                                <template x-if="paymentOption === 'full'">
                                    <span class="flex items-center">
                                        <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                        </svg>
                                        PAID
                                    </span>
                                </template>
                                <template x-if="paymentOption !== 'full'">
                                    <span>₱<span x-text="balanceAmount.toFixed(2)">0.00</span></span>
                                </template>
                            </span>
                        </div>
                    </div>

                    <!-- Due Date -->
                    <div>
                        <label class="block text-sm font-medium text-green-700 mb-2">
                            Due Date <span class="text-salmon-500">*</span>
                        </label>
                        <input type="date" name="due_date" x-model="dueDate" required
                               class="w-full px-4 py-3 border border-green-200 rounded-lg focus:ring-2 focus:ring-green-400 bg-white">
                    </div>
                </div>

                <!-- Special Instructions -->
                <div class="mt-6">
                    <label class="block text-sm font-medium text-green-700 mb-2">Special Instructions</label>
                    <textarea name="special_instructions" x-model="specialInstructions" rows="3"
                              class="w-full px-4 py-3 border border-green-200 rounded-lg focus:ring-2 focus:ring-green-400 bg-white resize-none"
                              placeholder="Enter any special instructions, design preferences, or notes..."></textarea>
                </div>
            </div>
        </div>

        <!-- Form Actions -->
        <div class="flex items-center justify-between py-4">
            <a href="{% url 'order_list' %}" class="px-6 py-3 text-green-600 hover:text-green-800 font-medium transition-colors">
                Cancel
            </a>
            <button type="submit" :disabled="!canSubmit"
                    :class="canSubmit ? 'bg-green-600 hover:bg-green-700' : 'bg-green-500 cursor-not-allowed'"
                    class="px-8 py-3 text-white rounded-xl shadow-lg transition-all duration-200 font-semibold flex items-center">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                Review & Create Order
            </button>
        </div>
    </form>

    <!-- ============================================== -->
    <!-- CONFIRMATION MODAL -->
    <!-- ============================================== -->
    <div x-show="showConfirmModal" x-cloak
         class="fixed inset-0 z-50 overflow-y-auto" 
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0">
        
        <!-- Backdrop -->
        <div class="fixed inset-0 bg-black/60 backdrop-blur-sm" @click="showConfirmModal = false"></div>
        
        <!-- Modal Content -->
        <div class="flex min-h-screen items-center justify-center p-4">
            <div class="relative bg-white rounded-2xl shadow-2xl w-full max-w-2xl mx-auto overflow-hidden"
                 x-transition:enter="transition ease-out duration-300"
                 x-transition:enter-start="opacity-0 scale-95 translate-y-4"
                 x-transition:enter-end="opacity-100 scale-100 translate-y-0"
                 x-transition:leave="transition ease-in duration-200"
                 x-transition:leave-start="opacity-100 scale-100"
                 x-transition:leave-end="opacity-0 scale-95">
                
                <!-- Modal Header -->
                <div class="bg-gradient-to-r from-brown-600 to-brown-700 px-6 py-5">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <div class="w-12 h-12 bg-white/20 rounded-full flex items-center justify-center mr-4">
                                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                                </svg>
                            </div>
                            <div>
                                <h3 class="text-xl font-bold text-white">Confirm Order</h3>
                                <p class="text-cream-500 text-sm">Please review the order details before proceeding</p>
                            </div>
                        </div>
                        <button @click="showConfirmModal = false" class="text-white/80 hover:text-white transition-colors">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Modal Body -->
                <div class="p-6 max-h-[60vh] overflow-y-auto">
                    <!-- Order Summary -->
                    <div class="space-y-4">
                        <!-- Customer Info -->
                        <div class="bg-cream-500 rounded-xl p-4 border border-cream-500">
                            <div class="flex items-center mb-3">
                                <svg class="w-5 h-5 text-green-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                                </svg>
                                <h4 class="font-semibold text-green-800">Customer</h4>
                            </div>
                            <p class="text-lg font-medium text-green-900" x-text="getCustomerName()"></p>
                            <p class="text-sm text-green-600" x-text="getCustomerPhone()"></p>
                        </div>

                         <!-- Order Details -->
                         <div class="bg-cream-500 rounded-xl p-4 border border-cream-500">
                             <div class="flex items-center mb-3">
                                 <svg class="w-5 h-5 text-green-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                     <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"/>
                                 </svg>
                                 <h4 class="font-semibold text-green-800">Order Details</h4>
                             </div>
                             <div class="grid grid-cols-2 gap-4">
                                 <div>
                                     <p class="text-sm text-green-600">Garment</p>
                                     <p class="font-medium text-green-900" x-text="garmentName"></p>
                                 </div>
                                 <div>
                                     <p class="text-sm text-green-600">Quantity</p>
                                     <p class="font-medium text-green-900" x-text="quantity"></p>
                                 </div>
                              <div>
                                      <p class="text-sm text-green-600">Fabric</p>
                                      <p class="font-medium text-green-900" x-text="fabricName"></p>
                                  </div>
                                  <div>
                                      <p class="text-sm text-green-600">Fabric to Use</p>
                                      <p class="font-medium text-green-900"><span x-text="fabricMetersUsed.toFixed(2)"></span>m</p>
                                  </div>
                                  <div>
                                      <p class="text-sm text-green-600">Due Date</p>
                                      <p class="font-medium text-green-900" x-text="formatDate(dueDate)"></p>
                                  </div>
                                  <div x-show="selectedAccessories.length > 0">
                                      <p class="text-sm text-green-600">Accessories</p>
                                      <p class="font-medium text-green-900" x-text="selectedAccessories.length + ' selected'"></p>
                                  </div>
                             </div>
                         </div>

                         <!-- Measurements Summary -->
                         <div class="bg-cream-500 rounded-xl p-4 border border-cream-500">
                             <div class="flex items-center mb-3">
                                 <svg class="w-5 h-5 text-green-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                     <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>
                                 </svg>
                                 <h4 class="font-semibold text-green-800">Measurements</h4>
                             </div>
                             <div x-show="showUpperMeasurements" class="mb-2">
                                 <p class="text-xs font-medium text-blue-700 mb-1">Upper Body</p>
                                 <div class="flex flex-wrap gap-2">
                                     <template x-for="field in upperMeasurements" :key="field">
                                         <span x-show="measurements[field]" class="inline-flex items-center px-2 py-1 bg-white rounded text-xs border border-green-200">
                                             <span class="text-green-600 capitalize mr-1" x-text="field.replace('_', ' ')"></span>
                                             <span class="font-bold text-green-800" x-text="measurements[field] + ' in'"></span>
                                         </span>
                                     </template>
                                     <template x-if="!upperMeasurements.some(f => measurements[f])">
                                         <span class="text-xs text-green-600 italic">No upper measurements provided</span>
                                     </template>
                                 </div>
                             </div>
                             <div x-show="showLowerMeasurements" class="mb-2">
                                 <p class="text-xs font-medium text-green-700 mb-1">Lower Body</p>
                                 <div class="flex flex-wrap gap-2">
                                     <template x-for="field in lowerMeasurements" :key="field">
                                         <span x-show="measurements[field]" class="inline-flex items-center px-2 py-1 bg-white rounded text-xs border border-green-200">
                                             <span class="text-green-600 capitalize mr-1" x-text="field.replace('_', ' ')"></span>
                                             <span class="font-bold text-green-800" x-text="measurements[field] + ' in'"></span>
                                         </span>
                                     </template>
                                     <template x-if="!lowerMeasurements.some(f => measurements[f])">
                                         <span class="text-xs text-green-600 italic">No lower measurements provided</span>
                                     </template>
                                 </div>
                             </div>
                             <div>
                                 <p class="text-xs font-medium text-purple-700 mb-1">Common</p>
                                 <div class="flex flex-wrap gap-2">
                                     <template x-for="field in bothMeasurements" :key="field">
                                         <span x-show="measurements[field]" class="inline-flex items-center px-2 py-1 bg-white rounded text-xs border border-green-200">
                                             <span class="text-green-600 capitalize mr-1" x-text="field.replace('_', ' ')"></span>
                                             <span class="font-bold text-green-800" x-text="measurements[field] + ' in'"></span>
                                         </span>
                                     </template>
                                     <template x-if="!bothMeasurements.some(f => measurements[f])">
                                         <span class="text-xs text-green-600 italic">No common measurements provided</span>
                                     </template>
                                 </div>
                             </div>
                         </div>

                         <!-- Inventory Deduction Warning -->
                         <div class="bg-pink-50 rounded-xl p-4 border border-amber-200">
                             <div class="flex items-start">
                                 <svg class="w-5 h-5 text-amber-600 mr-2 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                     <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                                 </svg>
                                 <div>
                                     <h4 class="font-semibold text-pink-500 mb-1">Inventory Deduction</h4>
                                     <p class="text-sm text-pink-500">The following will be deducted from inventory:</p>
                                     <ul class="mt-2 space-y-1 text-sm text-pink-500">
                                         <li class="flex items-center">
                                             <span class="w-2 h-2 bg-pink-500 rounded-full mr-2"></span>
                                             <span x-text="fabricName"></span>: <strong class="ml-1" x-text="fabricMetersUsed.toFixed(2) + 'm'"></strong>
                                         </li>
                                         <template x-for="accessoryId in selectedAccessories" :key="accessoryId">
                                             <li class="flex items-center">
                                                 <span class="w-2 h-2 bg-pink-500 rounded-full mr-2"></span>
                                                 <span x-text="getAccessoryName(accessoryId)"></span>: <strong class="ml-1" x-text="(accessoryQuantities[accessoryId] || 0)"></strong>
                                             </li>
                                         </template>
                                     </ul>
                                 </div>
                             </div>
                         </div>

                        <!-- Payment Summary -->
                        <div :class="paymentOption === 'full' ? 'bg-gradient-to-br from-green-600 to-green-700' : 'bg-gradient-to-br from-brown-600 to-brown-700'" class="rounded-xl p-5 text-white">
                            <div class="flex items-center justify-between mb-4">
                                <div class="flex items-center">
                                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"/>
                                    </svg>
                                    <h4 class="font-semibold">Payment Details</h4>
                                </div>
                                <template x-if="paymentOption === 'full'">
                                    <span class="bg-white/20 text-white px-3 py-1 rounded-full text-sm font-bold">FULL PAYMENT</span>
                                </template>
                            </div>
                            <div class="space-y-3">
                                <div class="flex justify-between items-center">
                                    <span class="text-white/80">Total Price</span>
                                    <span class="text-xl font-bold">₱<span x-text="totalPrice.toFixed(2)"></span></span>
                                </div>
                                <div class="border-t border-white/20 pt-3">
                                    <div class="flex justify-between items-center">
                                        <span class="text-white/80" x-text="paymentOption === 'full' ? 'Full Payment' : 'Deposit Required (50%)'"></span>
                                        <span class="text-2xl font-bold">₱<span x-text="depositAmount.toFixed(2)"></span></span>
                                    </div>
                                </div>
                                <template x-if="paymentOption !== 'full'">
                                    <div class="flex justify-between items-center text-sm">
                                        <span class="text-white/60">Balance After Deposit</span>
                                        <span class="text-white/80">₱<span x-text="balanceAmount.toFixed(2)"></span></span>
                                    </div>
                                </template>
                                <template x-if="paymentOption === 'full'">
                                    <div class="flex justify-between items-center text-sm bg-white/10 rounded-lg p-2 mt-2">
                                        <span class="flex items-center">
                                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                            </svg>
                                            No Balance Due
                                        </span>
                                        <span class="font-bold">FULLY PAID</span>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Modal Footer -->
                <div class="bg-cream-500 px-6 py-4 border-t border-cream-500">
                    <div class="flex items-center justify-between">
                        <button @click="showConfirmModal = false" 
                                class="px-6 py-3 text-green-600 hover:text-green-800 font-medium transition-colors">
                            Cancel
                        </button>
                        <button @click="submitOrder()" :disabled="isSubmitting"
                                class="px-8 py-3 bg-green-600 hover:bg-green-700 text-white rounded-xl shadow-lg transition-all duration-200 font-semibold flex items-center disabled:opacity-50">
                            <template x-if="!isSubmitting">
                                <span class="flex items-center">
                                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                    </svg>
                                    Confirm & Create Order
                                </span>
                            </template>
                            <template x-if="isSubmitting">
                                <span class="flex items-center">
                                    <svg class="animate-spin w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24">
                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                    </svg>
                                    Creating Order...
                                </span>
                            </template>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ============================================== -->
    <!-- DEPOSIT RECEIPT MODAL -->
    <!-- ============================================== -->
    <div x-show="showReceiptModal" x-cloak
         class="fixed inset-0 z-50 overflow-y-auto"
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100">
        
        <!-- Backdrop -->
        <div class="fixed inset-0 bg-black/60 backdrop-blur-sm"></div>
        
        <!-- Modal Content -->
        <div class="flex min-h-screen items-center justify-center p-4">
            <div class="relative bg-white rounded-2xl shadow-2xl w-full max-w-2xl mx-auto overflow-hidden"
                 x-transition:enter="transition ease-out duration-300 delay-100"
                 x-transition:enter-start="opacity-0 scale-95 translate-y-4"
                 x-transition:enter-end="opacity-100 scale-100 translate-y-0">
                
                <!-- Receipt Content (Printable A4) - Matching Claim Receipt Style -->
                <div id="deposit-receipt" class="receipt-page bg-white">
                    
                    <!-- HEADER - Brown bar like claim receipt -->
                    <div class="bg-green-600 text-white px-6 py-3">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <svg class="w-10 h-10 text-cream-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.121 14.121L19 19m-7-7l7-7m-7 7l-2.879 2.879M12 12L9.121 9.121m0 5.758a3 3 0 10-4.243 4.243 3 3 0 004.243-4.243zm0-5.758a3 3 0 10-4.243-4.243 3 3 0 004.243 4.243z"/>
                                </svg>
                                <div class="ml-3">
                                    <h1 class="text-2xl font-bold">El Senior Original Tailoring</h1>
                                    <p class="text-cream-500 text-xs">San Pablo, Dumingag, Zamboanga del Sur</p>
                                </div>
                            </div>
                            <div :class="paymentOption === 'full' ? 'bg-green-600' : 'bg-green-500'" class="text-white px-4 py-2 rounded-lg">
                                <span class="font-bold text-lg" x-text="paymentOption === 'full' ? 'FULLY PAID' : 'DEPOSIT PAID'"></span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- TITLE BAR - Cream like claim receipt -->
                    <div class="bg-cream-5000 border-b border-green-300 px-6 py-2 flex justify-between items-center">
                        <div>
                            <h2 class="text-xl font-bold text-green-800" x-text="paymentOption === 'full' ? 'PAYMENT RECEIPT' : 'DEPOSIT RECEIPT'"></h2>
                            <p class="text-green-600 text-sm">Order #<span x-text="createdOrderNumber"></span></p>
                        </div>
                        <div class="text-right">
                            <p class="text-xs text-green-600">Order Date</p>
                            <p class="font-bold text-green-800" x-text="formatDate(new Date())"></p>
                        </div>
                    </div>
                    
                    <!-- MAIN CONTENT -->
                    <div class="px-6 py-3">
                        
                        <!-- Customer & Order Info - Compact like claim receipt -->
                        <div class="grid grid-cols-2 gap-4 mb-3">
                            <div class="border border-green-200 rounded overflow-hidden">
                                <div class="bg-green-500 px-3 py-1 border-b border-green-200">
                                    <h3 class="font-bold text-green-700 uppercase text-xs">Customer Information</h3>
                                </div>
                                <div class="p-2 text-sm space-y-1">
                                    <div class="flex"><span class="text-green-600 w-16">Name:</span><span class="font-semibold text-green-800" x-text="getCustomerName()"></span></div>
                                    <div class="flex"><span class="text-green-600 w-16">Phone:</span><span class="text-green-800" x-text="getCustomerPhone()"></span></div>
                                </div>
                            </div>
                            
                            <div class="border border-green-200 rounded overflow-hidden">
                                <div class="bg-green-500 px-3 py-1 border-b border-green-200">
                                    <h3 class="font-bold text-green-700 uppercase text-xs">Order Information</h3>
                                </div>
                                <div class="p-2 text-sm space-y-1">
                                    <div class="flex"><span class="text-green-600 w-20">Order #:</span><span class="font-mono font-bold text-green-800" x-text="createdOrderNumber"></span></div>
                                    <div class="flex"><span class="text-green-600 w-20">Due Date:</span><span class="text-green-800 font-medium" x-text="formatDate(dueDate)"></span></div>
                                </div>
                            </div>
                        </div>
                        
                         <!-- Garment Details - Compact like claim receipt -->
                         <div class="border border-green-200 rounded overflow-hidden mb-3">
                             <div class="bg-green-500 px-3 py-1 border-b border-green-200">
                                 <h3 class="font-bold text-green-700 uppercase text-xs">Garment Details</h3>
                             </div>
                              <div class="p-2">
                                  <div class="grid grid-cols-4 gap-3 text-sm">
                                      <div>
                                          <span class="text-green-600 text-xs block">Garment Type</span>
                                          <p class="font-bold text-green-800" x-text="garmentName"></p>
                                      </div>
                                      <div>
                                          <span class="text-green-600 text-xs block">Fabric</span>
                                          <p class="font-semibold text-green-800" x-text="fabricName"></p>
                                      </div>
                                      <div>
                                          <span class="text-green-600 text-xs block">Fabric Used</span>
                                          <p class="font-semibold text-green-800"><span x-text="fabricMetersUsed.toFixed(2)"></span> meters</p>
                                      </div>
                                      <div>
                                          <span class="text-green-600 text-xs block">Quantity</span>
                                          <p class="font-bold text-green-800" x-text="quantity"></p>
                                      </div>
                                  </div>
                              </div>
                          </div>

                         <!-- Accessories - Compact -->
                         <div class="border border-green-200 rounded overflow-hidden mb-3" x-show="selectedAccessories.length > 0">
                             <div class="bg-green-500 px-3 py-1 border-b border-green-200">
                                 <h3 class="font-bold text-green-700 uppercase text-xs">Accessories</h3>
                             </div>
                             <div class="p-2 text-sm space-y-1">
                                 <template x-for="accessoryId in selectedAccessories" :key="accessoryId">
                                     <div class="flex justify-between">
                                         <span class="text-green-800"><span x-text="getAccessoryName(accessoryId)"></span> <span class="text-green-600 text-xs" x-text="'× ' + (accessoryQuantities[accessoryId] || 0)"></span></span>
                                         <span class="font-semibold text-green-800" x-text="(accessoryQuantities[accessoryId] || 0)"></span>
                                     </div>
                                 </template>
                             </div>
                         </div>

                          <!-- Measurements - Compact like claim receipt -->
                         <div class="border border-green-200 rounded overflow-hidden mb-3" x-show="Object.values(measurements).some(v => v)">
                             <div class="bg-green-500 px-3 py-1 border-b border-green-200">
                                 <h3 class="font-bold text-green-700 uppercase text-xs">Measurements (inches)</h3>
                             </div>
                             <div class="p-2">
                                 <div class="grid grid-cols-4 gap-x-4 gap-y-1 text-sm">
                                     <template x-for="(value, key) in measurements" :key="key">
                                         <div x-show="value" class="flex justify-between">
                                             <span class="text-green-600 capitalize text-xs" x-text="key.replace('_', ' ')"></span>
                                             <span class="font-bold text-green-800 text-xs" x-text="value"></span>
                                         </div>
                                     </template>
                                 </div>
                             </div>
                         </div>
                        
                        <!-- Payment Section - Two Columns like claim receipt -->
                        <div class="grid grid-cols-2 gap-4 mb-3">
                            <!-- Payment Details -->
                            <div class="border border-green-200 rounded overflow-hidden">
                                <div class="bg-green-500 px-3 py-1 border-b border-green-200">
                                    <h3 class="font-bold text-green-700 uppercase text-xs">Payment Details</h3>
                                </div>
                                <div class="p-2">
                                    <table class="w-full text-xs">
                                        <thead class="bg-cream-5000">
                                            <tr>
                                                <th class="px-2 py-1 text-left text-green-600">Description</th>
                                                <th class="px-2 py-1 text-right text-green-600">Amount</th>
                                            </tr>
                                        </thead>
                                        <tbody class="divide-y divide-cream-200">
                                            <tr>
                                                <td class="px-2 py-1 text-green-700" x-text="paymentOption === 'full' ? 'Full Payment (100%)' : 'Deposit Payment (50%)'"></td>
                                                <td class="px-2 py-1 text-right font-semibold text-green-600">P<span x-text="depositAmount.toFixed(2)"></span></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <!-- Payment Summary -->
                            <div class="border border-green-200 rounded overflow-hidden">
                                <div class="bg-green-500 px-3 py-1 border-b border-green-200">
                                    <h3 class="font-bold text-green-700 uppercase text-xs">Payment Summary</h3>
                                </div>
                                <div class="p-2 space-y-1 text-sm">
                                    <div class="flex justify-between">
                                        <span class="text-green-600">Total Amount:</span>
                                        <span class="text-green-800 font-medium">P<span x-text="totalPrice.toFixed(2)"></span></span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-green-700" x-text="paymentOption === 'full' ? 'Full Payment:' : 'Deposit Paid:'"></span>
                                        <span class="text-green-600 font-semibold">P<span x-text="depositAmount.toFixed(2)"></span></span>
                                    </div>
                                    <div class="flex justify-between pt-1 border-t-2 border-green-300">
                                        <span class="font-bold text-green-800">Balance Due:</span>
                                        <template x-if="paymentOption === 'full'">
                                            <span class="text-green-600 font-bold text-lg flex items-center">
                                                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                                </svg>
                                                PAID
                                            </span>
                                        </template>
                                        <template x-if="paymentOption !== 'full'">
                                            <span class="text-salmon-500 font-bold text-lg">P<span x-text="balanceAmount.toFixed(2)"></span></span>
                                        </template>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- FOOTER - Like claim receipt -->
                    <div class="border-t-2 border-green-300 bg-cream-500 px-6 py-3">
                        
                        <!-- Stamp + Signatures Row -->
                        <div class="flex items-center justify-between mb-3">
                            <!-- Customer Signature -->
                            <div class="text-center flex-1">
                                <div class="border-b-2 border-green-400 mb-1 h-10 mx-4"></div>
                                <p class="font-semibold text-green-700 text-sm">Customer Signature</p>
                                <p class="text-xs text-green-600" x-text="getCustomerName()"></p>
                            </div>
                            
                            <!-- Payment Stamp -->
                            <div class="flex-shrink-0 mx-6">
                                <div :class="paymentOption === 'full' ? 'border-green-600 bg-green-100' : 'border-green-500 bg-green-50'" class="border-4 rounded-lg px-6 py-2 transform -rotate-3">
                                    <p :class="paymentOption === 'full' ? 'text-green-700' : 'text-green-600'" class="font-bold text-xl tracking-wider text-center" x-text="paymentOption === 'full' ? 'FULLY PAID' : 'DEPOSIT PAID'"></p>
                                    <p :class="paymentOption === 'full' ? 'text-green-600' : 'text-green-500'" class="text-xs text-center" x-text="formatDate(new Date())"></p>
                                </div>
                            </div>
                            
                            <!-- Authorized Signature -->
                            <div class="text-center flex-1">
                                <div class="border-b-2 border-green-400 mb-1 h-10 mx-4"></div>
                                <p class="font-semibold text-green-700 text-sm">Authorized Signature</p>
                                <p class="text-xs text-green-600">El Senior Original Tailoring</p>
                            </div>
                        </div>
                        
                        <!-- Thank You -->
                        <div class="text-center bg-green-500 rounded py-2 px-4 mb-3">
                            <p class="text-green-700 font-bold">Thank you for choosing El Senior Original Tailoring!</p>
                            <p class="text-green-600 text-xs">Expected completion: <span class="font-semibold" x-text="formatDate(dueDate)"></span></p>
                        </div>
                        
                        <!-- Terms & Contact - Compact -->
                        <div class="grid grid-cols-2 gap-4 text-xs text-green-600 border-t border-green-200 pt-2">
                            <div>
                                <p class="font-bold text-green-700 mb-1">Terms & Conditions:</p>
                                <ul class="list-disc list-inside space-y-0.5">
                                    <template x-if="paymentOption !== 'full'">
                                        <li>Balance due upon pickup</li>
                                    </template>
                                    <template x-if="paymentOption === 'full'">
                                        <li>Order is fully paid - no balance due</li>
                                    </template>
                                    <li>Present this receipt when claiming</li>
                                    <li>Keep this receipt for reference</li>
                                </ul>
                            </div>
                            <div class="text-right">
                                <p class="font-bold text-green-700 mb-1">Contact:</p>
                                <p>San Pablo, Dumingag</p>
                                <p>Zamboanga del Sur</p>
                                <p class="mt-1 text-cream-600">Receipt #<span x-text="createdOrderNumber"></span></p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons (no-print) -->
                <div class="bg-cream-500 px-6 py-4 border-t border-cream-500 no-print">
                    <div class="flex items-center justify-between gap-4">
                        <a :href="'/orders/' + createdOrderId + '/'" 
                           class="flex-1 px-6 py-3 text-center text-green-600 border border-green-300 rounded-xl hover:bg-pink-50000 font-medium transition-colors">
                            View Order
                        </a>
                        <button @click="printReceipt()" 
                                class="flex-1 px-6 py-3 bg-green-600 hover:bg-green-700 text-white rounded-xl font-semibold transition-colors flex items-center justify-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"/>
                            </svg>
                            Print Receipt
                        </button>
                    </div>
                    <div class="mt-3">
                        <a href="{% url 'order_create' %}" 
                           class="block w-full text-center px-6 py-3 bg-green-600 hover:bg-green-700 text-white rounded-xl font-semibold transition-colors">
                            <svg class="w-5 h-5 inline mr-2 -mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                            </svg>
                            Create Another Order
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function orderForm() {
    return {
        init() {
            // Populate fabric colors
            const colorSet = new Set(this.allFabrics.map(f => f.color));
            const colorSelect = document.getElementById('id_fabric_color');
            colorSet.forEach(color => {
                const option = document.createElement('option');
                option.value = color;
                option.textContent = color;
                colorSelect.appendChild(option);
            });

            // Populate all fabrics initially
            this.filterFabricsByColor();
        },

        // Customer
        customerMode: 'existing',
        selectedCustomer: '',
        newCustomerName: '',
        newCustomerPhone: '',
        customerName: '',
        customerPhone: '',
        
         // Garment & Fabric
        selectedGarment: '',
        selectedFabric: '',
        garmentName: '',
        garmentCategory: '',
        fabricName: '',
        quantity: 1,
        selectedFabricColor: '',
        estimatedFabricPerUnit: 0,
        fabricMetersUsed: 0,
        allFabrics: [{% for fabric in fabrics %}{ id: {{ fabric.pk }}, name: '{{ fabric.material.name }}', color: '{{ fabric.color.name }}', stock: {{ fabric.stock_meters }} }{% if not forloop.last %},{% endif %}{% endfor %}],
        filteredFabrics: [],
         allAccessories: [{% for accessory in accessories %}{ id: {{ accessory.pk }}, name: '{{ accessory.name }}', unit: '{{ accessory.unit }}', stock: {{ accessory.stock_quantity }} }{% if not forloop.last %},{% endif %}{% endfor %}],
         selectedAccessories: [],
         accessoryQuantities: {},
         accessorySearch: '',

         get filteredAccessories() {
             if (!this.accessorySearch) {
                 return this.allAccessories;
             }
             const search = this.accessorySearch.toLowerCase();
             return this.allAccessories.filter(accessory =>
                 accessory.name.toLowerCase().includes(search)
             );
         },

          // Measurement categories
        measurementCategories: {
            upper: {
                label: 'Upper Body Measurements',
                fields: ['chest', 'shoulder', 'sleeve_length', 'arm_hole', 'cuff', 'neck', 'body_length']
            },
            lower: {
                label: 'Lower Body Measurements',
                fields: ['inseam', 'outseam', 'thigh', 'knee', 'hem', 'rise']
            },
            both: {
                label: 'Common Measurements',
                fields: ['waist', 'hips']
            }
        },

        get upperMeasurements() {
            return this.measurementCategories.upper.fields;
        },

        get lowerMeasurements() {
            return this.measurementCategories.lower.fields;
        },

        get bothMeasurements() {
            return this.measurementCategories.both.fields;
        },

        get showUpperMeasurements() {
            return this.garmentCategory === 'upper' || this.garmentCategory === 'both';
        },

        get showLowerMeasurements() {
            return this.garmentCategory === 'lower' || this.garmentCategory === 'both';
        },
        
        // Fabric requirements
        fabricPerUnit: 0,
        fabricAvailable: 0,
        hasSufficientStock: true,
        hasSufficientAccessoryStock: true,
        
        // Measurements
        measurements: {
            chest: '',
            waist: '',
            hips: '',
            shoulder: '',
            sleeve_length: '',
            arm_hole: '',
            cuff: '',
            body_length: '',
            inseam: '',
            outseam: '',
            thigh: '',
            knee: '',
            hem: '',
            rise: '',
            neck: ''
        },
        
        // Pricing
        paymentOption: 'deposit', // 'deposit' or 'full'
        totalPrice: 0,
        depositAmount: 0,
        balanceAmount: 0,
        
        // Schedule
        dueDate: '',
        specialInstructions: '',
        
        // Modal states
        showConfirmModal: false,
        showReceiptModal: false,
        isSubmitting: false,
        
        // Created order info
        createdOrderId: null,
        createdOrderNumber: '',
        
        get canSubmit() {
            const hasCustomer = this.customerMode === 'existing' ? this.selectedCustomer : (this.newCustomerName && this.newCustomerPhone);
            return hasCustomer && this.selectedGarment && this.selectedFabric && this.fabricMetersUsed > 0 && this.totalPrice > 0 && this.dueDate && this.hasSufficientStock && this.hasSufficientAccessoryStock;
        },
        
        updateCustomerInfo() {
            const select = document.getElementById('id_customer');
            if (select && select.selectedOptions[0]) {
                this.customerName = select.selectedOptions[0].dataset.name || '';
                this.customerPhone = select.selectedOptions[0].dataset.phone || '';
            }
        },
        
          updateGarmentInfo() {
             const select = document.getElementById('id_garment_type');
             if (select && select.selectedOptions[0] && this.selectedGarment) {
                 this.garmentName = select.selectedOptions[0].dataset.name || '';
                 this.garmentCategory = select.selectedOptions[0].dataset.category || '';
                 this.estimatedFabricPerUnit = parseFloat(select.selectedOptions[0].dataset.fabric) || 0;
                 const basePrice = parseFloat(select.selectedOptions[0].dataset.price) || 0;
                 this.totalPrice = basePrice * this.quantity;
                 // Set suggested fabric meters as default if not already set
                 if (!this.fabricMetersUsed) {
                     this.fabricMetersUsed = this.estimatedFabricPerUnit * this.quantity;
                 }
                 console.log('Garment selected:', this.garmentName, 'Category:', this.garmentCategory);
                 this.calculateDeposit();
             } else {
                 this.garmentName = '';
                 this.garmentCategory = '';
                 this.estimatedFabricPerUnit = 0;
                 this.totalPrice = 0;
             }
         },

         updateFabricInfo() {
            const select = document.getElementById('id_fabric');
            if (select && select.selectedOptions[0] && this.selectedFabric) {
                const fabric = this.allFabrics.find(f => f.id == this.selectedFabric);
                if (fabric) {
                    this.fabricName = fabric.name + ' (' + fabric.color + ')';
                    this.fabricAvailable = fabric.stock;
                    this.checkStock();
                }
            }
        },

         filterFabricsByColor() {
            const fabricSelect = document.getElementById('id_fabric');
            fabricSelect.innerHTML = '<option value="">-- Select fabric --</option>';
            
            let filtered = this.allFabrics;
            if (this.selectedFabricColor) {
                filtered = this.allFabrics.filter(f => f.color === this.selectedFabricColor);
            }
            
            filtered.forEach(fabric => {
                const option = document.createElement('option');
                option.value = fabric.id;
                option.dataset.name = fabric.name + ' (' + fabric.color + ')';
                option.dataset.stock = fabric.stock;
                option.textContent = fabric.name + ' (' + fabric.color + ') - ' + fabric.stock + 'm';
                fabricSelect.appendChild(option);
            });
            
            this.filteredFabrics = filtered;
            this.selectedFabric = '';
            this.fabricName = '';
            this.fabricAvailable = 0;
            this.fabricMetersUsed = 0;
        },

         updateAccessoryQuantity(accessoryId) {
            const id = String(accessoryId);
            if (this.selectedAccessories.includes(accessoryId)) {
                this.accessoryQuantities[id] = this.accessoryQuantities[id] || 1;
            } else {
                delete this.accessoryQuantities[id];
            }
            this.checkAccessoryStock();
         },

         increaseAccessoryQuantity(accessoryId) {
            const id = String(accessoryId);
            if (!this.accessoryQuantities[id]) {
                this.accessoryQuantities[id] = 0;
            }
            this.accessoryQuantities[id] = parseFloat((this.accessoryQuantities[id] + 0.5).toFixed(2));
            this.checkAccessoryStock(accessoryId);
         },

         decreaseAccessoryQuantity(accessoryId) {
            const id = String(accessoryId);
            const current = parseFloat(this.accessoryQuantities[id]) || 0;
            if (current > 0) {
                const newQty = Math.max(0, parseFloat((current - 0.5).toFixed(2)));
                if (newQty === 0) {
                    delete this.accessoryQuantities[id];
                } else {
                    this.accessoryQuantities[id] = newQty;
                }
                this.checkAccessoryStock(accessoryId);
            }
         },


         getAccessoryName(accessoryId) {
            const accessory = this.allAccessories.find(a => a.id == accessoryId);
            return accessory ? accessory.name : '';
         },

         getAccessoryStock(accessoryId) {
            const accessory = this.allAccessories.find(a => a.id == accessoryId);
            return accessory ? accessory.stock : 0;
         },

         checkAccessoryStock(accessoryId) {
            const id = String(accessoryId);
            const qty = parseFloat(this.accessoryQuantities[id]) || 0;
            const stock = this.getAccessoryStock(id);
            const hasStock = qty <= stock;

            // Update overall stock status
            let allHaveStock = true;
            for (const accId of this.selectedAccessories) {
                const accIdStr = String(accId);
                const itemQty = parseFloat(this.accessoryQuantities[accIdStr]) || 0;
                const itemStock = this.getAccessoryStock(accId);
                if (itemQty > itemStock) {
                    allHaveStock = false;
                    break;
                }
            }
            this.hasSufficientAccessoryStock = allHaveStock;
         },

         calculateAll() {
             this.checkStock();
             this.calculateDeposit();
         },

         checkStock() {
            this.hasSufficientStock = this.fabricAvailable >= this.fabricMetersUsed;
         },
        
        calculateDeposit() {
            if (this.paymentOption === 'full') {
                this.depositAmount = Math.round(this.totalPrice * 100) / 100;
                this.balanceAmount = 0;
            } else {
                this.depositAmount = Math.round(this.totalPrice * 0.5 * 100) / 100;
                this.balanceAmount = Math.round((this.totalPrice - this.depositAmount) * 100) / 100;
            }
        },
        
        getCustomerName() {
            if (this.customerMode === 'new') {
                return this.newCustomerName || 'New Customer';
            }
            return this.customerName || 'Selected Customer';
        },
        
        getCustomerPhone() {
            if (this.customerMode === 'new') {
                return this.newCustomerPhone || '';
            }
            return this.customerPhone || '';
        },
        
        formatDate(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-US', { 
                weekday: 'short',
                year: 'numeric', 
                month: 'short', 
                day: 'numeric' 
            });
        },
        
        showConfirmation() {
            if (!this.canSubmit) {
                alert('Please fill in all required fields and ensure sufficient stock.');
                return;
            }
            this.updateCustomerInfo();
            this.showConfirmModal = true;
        },
        
        async submitOrder() {
            this.isSubmitting = true;
            
            try {
                const formData = new FormData();
                formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
                
                // Customer
                if (this.customerMode === 'new') {
                    formData.append('create_new_customer', 'true');
                    formData.append('new_customer_name', this.newCustomerName);
                    formData.append('new_customer_phone', this.newCustomerPhone);
                } else {
                    formData.append('customer', this.selectedCustomer);
                }
                
                 // Order details
                 formData.append('garment_type', this.selectedGarment);
                 formData.append('fabric', this.selectedFabric);
                 formData.append('quantity', this.quantity);
                 formData.append('fabric_meters_used', this.fabricMetersUsed);
                 formData.append('total_price', this.totalPrice);
                 formData.append('payment_option', this.paymentOption);
                 formData.append('due_date', this.dueDate);
                 formData.append('special_instructions', this.specialInstructions);

                 // Accessories
                 formData.append('selected_accessories', JSON.stringify(this.selectedAccessories));
                 formData.append('accessory_quantities', JSON.stringify(this.accessoryQuantities));

                 // Measurements
                 for (const [key, value] of Object.entries(this.measurements)) {
                     if (value) formData.append(key, value);
                 }

                
                const response = await fetch('{% url "order_create" %}', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    this.createdOrderId = data.order_id;
                    this.createdOrderNumber = data.order_number;
                    this.showConfirmModal = false;
                    this.showReceiptModal = true;
                } else {
                    alert(data.error || 'Failed to create order. Please try again.');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred. Please try again.');
            } finally {
                this.isSubmitting = false;
            }
        },
        
        printReceipt() {
            const receiptContent = document.getElementById('deposit-receipt').innerHTML;
            const printWindow = window.open('', '_blank', 'width=800,height=600');
            printWindow.document.write(`
<!DOCTYPE html>
<html>
<head>
    <title>Deposit Receipt - El Senior Original Tailoring</title>
    <script src="https://cdn.tailwindcss.com"><\/script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        cream: {
                            50: '#FFFDF7',
                            100: '#FFF9E6',
                            200: '#FFF3CC',
                            300: '#FFECB3',
                        },
                        brown: {
                            50: '#FAF6F1',
                            100: '#F0E6D8',
                            200: '#E0CCB0',
                            300: '#C9A97C',
                            400: '#A67C52',
                            500: '#8B5E34',
                            600: '#6D4A2A',
                            700: '#553A21',
                            800: '#3D2A18',
                            900: '#2A1D10',
                        }
                    }
                }
            }
        }
    <\/script>
    <style>
        @media print {
            @page { 
                size: A4 portrait; 
                margin: 0; 
            }
            
            * {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                color-adjust: exact !important;
            }
            
            html, body {
                width: 210mm;
                height: 297mm;
                margin: 0 !important;
                padding: 0 !important;
                font-size: 11px !important;
                background: white !important;
            }
            
            .receipt-page {
                width: 210mm !important;
                height: 297mm !important;
                padding: 8mm 12mm !important;
                box-sizing: border-box !important;
            }
            
            .no-print { display: none !important; }
            
            /* Background colors */
            .bg-green-600 { background-color: #6D4A2A !important; }
            .bg-green-600 { background-color: #8B5E34 !important; }
            .bg-green-500 { background-color: #F0E6D8 !important; }
            .bg-cream-5000 { background-color: #FFF9E6 !important; }
            .bg-cream-500 { background-color: #FFFDF7 !important; }
             .bg-green-500 { background-color: #22c55e !important; }
             .bg-green-50 { background-color: #f0fdf4 !important; }
             .bg-green-100 { background-color: #dcfce7 !important; }
             .bg-blue-100 { background-color: #dbeafe !important; }
             .bg-purple-100 { background-color: #f3e8ff !important; }

             /* Text colors */
             .text-white { color: white !important; }
             .text-cream-500 { color: #FFF3CC !important; }
             .text-cream-500 { color: #FFF9E6 !important; }
             .text-green-600 { color: #16a34a !important; }
             .text-green-500 { color: #22c55e !important; }
             .text-green-800 { color: #166534 !important; }
             .text-blue-700 { color: #1d4ed8 !important; }
             .text-purple-700 { color: #7c3aed !important; }
             .text-salmon-500 { color: #dc2626 !important; }
            
            /* Border colors */
            .border-green-500 { border-color: #22c55e !important; }
            .border-green-200 { border-color: #E0CCB0 !important; }
            .border-green-300 { border-color: #C9A97C !important; }
            .border-green-400 { border-color: #A67C52 !important; }
        }
        
        /* Screen preview styles */
        body {
            background: #f3f4f6;
            padding: 20px;
        }
        .receipt-page {
            max-width: 210mm;
            margin: 0 auto;
            background: white;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <div class="receipt-page bg-white">
        ${receiptContent}
    </div>
    <script>
        // Wait for Tailwind to load, then print
        setTimeout(function() {
            window.print();
            window.onafterprint = function() {
                window.close();
            };
        }, 500);
    <\/script>
</body>
</html>
            `);
            printWindow.document.close();
        }
    }
}
</script>
{% endblock %}
